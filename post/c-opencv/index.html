<html>
<head>
    <meta charset="utf-8"/>
<meta name="description" content=""/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>C++ OpenCV | Yuchuan&#39;s Blog</title>

<link rel="shortcut icon" href="https://kimokcheon.github.io//favicon.ico?v=1695778991029">

<link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://kimokcheon.github.io//styles/main.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/css/bootstrap.min.css">

<script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets/highlight.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.15.10/languages/dockerfile.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.15.10/languages/dart.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/moment@2.27.0/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/js/bootstrap.min.js"></script>
<!-- DEMO JS -->
<!--<script src="media/scripts/index.js"></script>-->



    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.css">
</head>
<body>
<div class="main gt-bg-theme-color-first">
    <nav class="navbar navbar-expand-lg">
    <div class="navbar-brand">
        <img class="user-avatar" src="/images/avatar.png" alt="头像">
        <div class="site-name gt-c-content-color-first">
            Yuchuan&#39;s Blog
        </div>
    </div>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <i class="fas fa-bars gt-c-content-color-first" style="font-size: 18px"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <div class="navbar-nav mr-auto" style="text-align: center">
            
                <div class="nav-item">
                    
                        <a href="/" class="menu gt-a-link">
                            首页
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="/archives" class="menu gt-a-link">
                            归档
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="/tags" class="menu gt-a-link">
                            标签
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="https://kimokcheon.github.io/post/about-me" class="menu gt-a-link">
                            关于
                        </a>
                    
                </div>
            
        </div>
        <div style="text-align: center">
            <form id="gridea-search-form" style="position: relative" data-update="1695778991029" action="/search/index.html">
                <input class="search-input" autocomplete="off" spellcheck="false" name="q" placeholder="搜索文章" />
                <i class="fas fa-search gt-c-content-color-first" style="position: absolute; top: 9px; left: 10px;"></i>
            </form>
        </div>
    </div>
</nav>

    <div class="post-container">
        <div class="post-detail gt-bg-theme-color-second">
            <article class="gt-post-content">
                <h2 class="post-title">
                    C++ OpenCV
                </h2>
                <div class="post-info">
                    <time class="post-time gt-c-content-color-first">
                        · 2023-06-27 ·
                    </time>
                    
                </div>
                <div class="post-content">
                    <h1 id="1-opencv头文件">1. OpenCV头文件</h1>
<ul>
<li>cv.hpp和opencv.hpp是等同的关系。只不过，前者是早期opencv版本中的定义名称，而后者opencv.hpp则是3.0版本之后的表示方法。</li>
<li>cv.hpp和opencv.hpp都包含了一下头文件
<ul>
<li>#include &lt;opencv2/core.hpp&gt;</li>
<li>#include &lt;opencv2/imgproc.hpp&gt;</li>
<li>#include &lt;opencv2/video.hpp&gt;</li>
<li>#include &lt;opencv2/objdetect.hpp&gt;</li>
<li>#include &lt;opencv2/imgcodecs.hpp&gt;</li>
<li>#include &lt;opencv2/highgui.hpp&gt;</li>
<li>#include &lt;opencv2/ml.hpp&gt;</li>
</ul>
</li>
</ul>
<p>简言之，我们在编写代码的时候，或许只需要一个简单的<code>#include&lt;opencv2/opencv.hpp&gt;</code>就可以轻松的解决红色波浪线未定义字符的烦恼。<br>
<code>.hpp</code>和<code>.h</code>文件差别是<code>.hpp</code>把还包含了函数实现。</p>
<hr>
<p><br><br></p>
<h1 id="2-mat和mat_">2. Mat和Mat_</h1>
<h2 id="21-mat">2.1 Mat</h2>
<ul>
<li>图像的表示：最老的C接口的OpenCV版本中，用 <em><strong>IplImage</strong></em> ，需要手动管理内存。C++接口的OpenCV中，用 <em><strong>Mat</strong></em> ，不用手动管理内存。</li>
<li>浅拷贝：Mat对象的赋值运算或拷贝构造函数只拷贝Header，不拷贝矩阵数据，对一个对象的修改会影响其他对象。</li>
</ul>
<pre><code class="language-C==">Mat A, C;                          // creates just the header parts
A = imread(argv[1], IMREAD_COLOR); // here we'll know the method used (allocate matrix)
Mat B(A);                          // Use the copy constructor
C = A;                             // Assignment operator
</code></pre>
<ul>
<li>深拷贝：可用<code>cv::Mat::clone()</code>和<code>cv::Mat::copyTo()</code>实现图像矩阵数据的拷贝。</li>
</ul>
<pre><code class="language-C++">Mat F = A.clone();    
Mat G;
A.copyTo(G);
</code></pre>
<ul>
<li>除此之外，cv::Mat还有如下常用属性：<br>
API reference: https://docs.opencv.org/3.1.0/d3/d63/classcv_1_1Mat.html</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">成员函数</th>
<th style="text-align:left">解释</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">void cv::Mat::create (int rows, int cols, int type)</td>
<td style="text-align:left">创建矩阵</td>
</tr>
<tr>
<td style="text-align:left">_Tp&amp; cv::Mat::at (int i0, int i1)</td>
<td style="text-align:left">例如用<code>image.at&lt;Vec3b&gt;(y,x)[c]</code>访问y行x列c通道的值</td>
</tr>
<tr>
<td style="text-align:left">uchar * ptr<T>()</td>
<td style="text-align:left">行指针，例如<code>image.ptr&lt;uchar&gt;(1)</code>为指向第1行首地址的指针</td>
</tr>
<tr>
<td style="text-align:left">int cv::Mat::channels () const</td>
<td style="text-align:left">矩阵元素的通道数，例如RGB为三个通道</td>
</tr>
<tr>
<td style="text-align:left">int cv::Mat::type () const</td>
<td style="text-align:left">它是一系列的预定义的常量，命名规则为<code>CV_+（位数）+（数据类型）+ C +（通道数）</code>，例如<code>CV_8UC1</code></td>
</tr>
<tr>
<td style="text-align:left">int cv::Mat::depth () const</td>
<td style="text-align:left">返回矩阵元素的深度，例如一个8-bit signed element array，返回<code>CV_8U</code></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th style="text-align:left">成员变量</th>
<th style="text-align:left">解释</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">uchar* cv::Mat::data</td>
<td style="text-align:left">uchar类型的指针，指向Mat数据矩阵的首地址</td>
</tr>
<tr>
<td style="text-align:left">int cv::Mat::dims</td>
<td style="text-align:left">Mat矩阵的维度，若Mat是一个二维矩阵，则 dims=2，三维则 dims=3</td>
</tr>
<tr>
<td style="text-align:left">int cv::Mat::cols</td>
<td style="text-align:left">矩阵列数，如果 dims&gt;2 为-1</td>
</tr>
<tr>
<td style="text-align:left">int cv::Mat::rows</td>
<td style="text-align:left">矩阵行数，如果 dims&gt;2 为-1</td>
</tr>
<tr>
<td style="text-align:left">cv::Mat::<strong>step</strong></td>
<td style="text-align:left">步长，指为了便于访问矩阵元素，需要移动多少距离，例如多幅同样大小的图像组成的3维矩阵: <br> step[0] 指从当前图像开始处到下一图像的开始处跨越多少字节 <br> step[1] 指从当前图像行首到下一行首相距多少字节 <br> step[2] 从当前像素到下一像素步长是多少 <br> image.step这样的用法也就是image.step[0]的意思</td>
</tr>
<tr>
<td style="text-align:left">cv::Mat:: <strong>size</strong></td>
<td style="text-align:left">是指多维矩阵中每一维的大小，例如多幅同样大小的图像组成的3维矩阵:  <br> size[0] 指有共有多少幅图像 <br> size[1] 指单幅图像有多少行 <br> size[3] 指单幅图像有多少列</td>
</tr>
</tbody>
</table>
<ul>
<li><code>cv::Mat</code>下图像的遍历方法：</li>
</ul>
<pre><code class="language-C++">//*********遍历方法1：.at 操作***********//
for(int y = 0; y &lt; image.rows; y++) {
    for( int x = 0; x &lt; image.cols; x++) {
        for( int c = 0; c &lt; image.channels(); c++) {
            new_image.at&lt;Vec3b&gt;(y,x)[c] = saturate_cast&lt;uchar&gt;(alpha*image.at&lt;Vec3b&gt;(y,x)[c] + beta);
            // saturate_cast&lt;&gt;实现从一个类型到另一个类型的映射（saturate的意思是按比例缩放至saturation）
        }
    }
}
 
//*********更高效的遍历方法：用行指针***************//
for (size_t y=0; y&lt;image.rows; y++) {     // size_t在C语言中就有了，是一种用来记录大小的数据类型，此处也可用int代替 
    unsigned char* row_ptr = image.ptr&lt;unsigned char&gt; (y); // row_ptr是第y行的头指针
    for（size_t x=0; x&lt;image.cols; x++）{
        unsigned char* data_ptr = &amp;row_ptr[x * image.channels()]; // data_ptr为指向像素数据的指针
        for (int c = 0; c != image.channels(); c++) {
            unsigned char data = data_ptr[c]; // data为I(x,y)第c个通道的值
        }
    }
}


// unsigned char范围为0-255。 eg. 若image.depth() == CV_8U，则每个像素每个通道都是用0-255表示  
// OpenCV库中定义Vec3b的语句：`typedef Vec&lt;uchar, 3&gt; cv::Vec3b`，所以`Vec3b`表示一个uchar类型的数组，长度为3。
    //其中`cv::Vec&lt; _Tp, cn &gt;`是OpenCV中定义的一个类，继承了`cv::Matx&lt; _Tp, m, n &gt;`这个类。
</code></pre>
<h2 id="22-mat_">2.2 Mat_</h2>
<p>一些代码中用到cv::Mat_，Mat_继承了Mat类，但比Mat类并没有更多的东西。只是在编译前就能确定元素类型时，用Mat_会更方便。</p>
<blockquote>
<p>例如：<br>
Mat访问元素调用的是 Mat::at(int y,int x)， <code>Mat image(100,100,CV_8U);  image.at(1,2) = 2;</code><br>
Mat_访问元素调用的是 Mat_::operator()(int y,int x))， <code>Mat_&lt;double&gt; image(20,20);  image(1,2) = 3;</code></p>
</blockquote>
<pre><code class="language-C++">template&lt;typename T&gt; class Mat_ : public Mat
{
public:
    // ... some specific methods
    //         and
    // no new extra fields
};
</code></pre>
<hr>
<p><br><br></p>
<h1 id="3-实践">3. 实践</h1>
<ul>
<li>OpenCV读取多个读取多个IP摄像头的视频流</li>
</ul>
<blockquote>
<p>https://zhuanlan.zhihu.com/p/38136322</p>
</blockquote>
<ul>
<li>用 cv2 写视频</li>
</ul>
<blockquote>
<p>https://blog.csdn.net/Arctic_Beacon/article/details/111587432<br>
https://stackoverflow.com/questions/57235454/opencv-video-write-out-size-is-reduced</p>
</blockquote>
<pre><code class="language-python">filename_rgb = f&quot;{foldername}/rgb.avi&quot;
fourcc_rgb = cv2.VideoWriter_fourcc(*'XVID')  # size: `fourcc = 0` &gt; HFYU &gt;&gt; MJPG &gt;&gt; DIVX = XVID
# fourcc_rgb = 0      # the raw video, no compression
vout_rgb = cv2.VideoWriter()
vout_rgb.open(filename_rgb, fourcc_rgb, 30, (640, 480), isColor=True)
 
while 1:
   vout_rgb.write(rgbframe)
</code></pre>

                </div>
            </article>
        </div>

        
            <div class="next-post">
                <div class="next gt-c-content-color-first">下一篇</div>
                <a href="https://kimokcheon.github.io/post/cuda-install/" class="post-title gt-a-link">
                    CUDA Installation
                </a>
            </div>
        

        

        

        
            <script src='https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js'></script>

<style>
	div#vcomments{
		width:100%;
		max-width: 1000px;
		padding: 2.5%
	}
</style>


	<div id="vcomments"></div>

<script>
	new Valine({
		el: '#vcomments',
		appId: '',
		appKey: '',
		avatar: '',
		pageSize: 5,
		recordIp: false,
		placeholder: 'Just Go Go',
		visitor: false,
	});
</script>

        

        <div class="site-footer gt-c-content-color-first">
    <div class="slogan gt-c-content-color-first">他们都是萤火，聚在一起就成了太阳</div>
    <div class="social-container">
        
            
                <a href="https://github.com/Kimokcheon" target="_blank">
                    <i class="fab fa-github gt-c-content-color-first"></i>
                </a>
            
        
            
        
            
        
            
                <a href="https://www.zhihu.com/people/deng-yu-chuan-4" target="_blank">
                    <i class="fab fa-zhihu gt-c-content-color-first"></i>
                </a>
            
        
            
        
            
        
    </div>
    <div class="footer-info">
        Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a>
    </div>
    <div>
        Theme by <a href="https://imhanjie.com/" target="_blank">imhanjie</a>, Powered by <a
                href="https://github.com/getgridea/gridea" target="_blank">Gridea | <a href="https://kimokcheon.github.io//atom.xml" target="_blank">RSS</a></a>
    </div>
</div>

<script>
  hljs.initHighlightingOnLoad()
</script>

    </div>
</div>
</body>
</html>
